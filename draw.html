<html>
    <body>

        <canvas id="canvas" style="border: 1px solid" width="800" height="400"></canvas>
        <h1>Coordinates: <span id="coords"></span></h1>
        <h3>Received: <span id="wsreceived"></span></h3>
        <h3>Sent: <span id="wssent"></span></h3>
        <h3>Delay: Server - <span id="serverdelay"></span>ms, Client <span id="clientdelay"></span>ms</h3>
        <button onclick="sendCanvasClear()">Clear</button>
    </body>
    <script>
        let wsReceived = 0;
        let wsSent = 0;
        var coords = document.getElementById("coords")
        var wsreceived = document.getElementById("wsreceived")
        var wssent = document.getElementById("wssent")
        var serverdelay = document.getElementById("serverdelay")
        var clientdelay = document.getElementById("clientdelay")

        const ws = new WebSocket(`ws://${window.location.host}/ws/`)
        fetch(`http://${window.location.host}/sub`)

        function wsSendObject(obj) {
            const d = new Date()
            obj.ctime = d.getTime()
            ws.send(JSON.stringify(obj))
            wsSent++
            wssent.textContent = wsSent
        }

        ws.onopen = function() {
            ws.send(JSON.stringify({
                t: "connected"
            }))
        }
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data)
            const d = new Date()
            data.cdelay = d.getTime() - data.ctime
            wsReceived++
            wsreceived.textContent = wsReceived
            serverdelay.textContent = data.sdelay
            clientdelay.textContent = data.cdelay
            //console.log(data)
            if (data.t === 'draw') {
                drawAllCanvas(data.fx, data.fy, data.tx, data.ty)
            }
            else if (data.t === 'clear') {
                clearAllCanvases()
            }
        }

        function sendCanvasCoords(canvas, fx, fy, tx, ty) {
            wsSendObject({
                c: canvas,
                fx: fx,
                fy: fy,
                tx: tx,
                ty: ty,
                t: 'draw'
            })
        }

        function sendCanvasClear() {
            wsSendObject({
                t: 'clear'
            })
        }

        var canvases = [
            "canvas"
        ]


        let localX = 0
        let localY = 0

        var c = {}
        for (let canv of canvases) {
            cv = document.getElementById(canv)
            c[canv] = {
                name: canv,
                x: 0,
                y: 0,
                canvas: cv,
                ctx: cv.getContext('2d'),
                source: 'foo'
            }
            cv.addEventListener('mousemove', function(e) {
                if (e.buttons !== 1) return;
                var { realX, realY } = getRealCoordinates(c[canv], e.clientX, e.clientY);
                sendCanvasCoords(c[canv].name, localX, localY, realX, realY)
                localX = realX
                localY = realY
            });

            cv.addEventListener('mousedown', function(e) {
                var { realX, realY } = getRealCoordinates(c[canv], e.clientX, e.clientY);
                localX = realX
                localY = realY
            })
        }

        function drawAllCanvas(fx, fy, tx, ty) {
            for (const [_, canvas] of Object.entries(c)) {
                drawCanvas(canvas, fx, fy, tx, ty)
            }
        }

        function drawCanvas(canvas, fx, fy, tx, ty) {
            canvas.ctx.beginPath();
            canvas.ctx.lineWidth = 2;
            canvas.ctx.moveTo(fx, fy)
            canvas.ctx.lineTo(tx, ty)
            canvas.ctx.stroke();
            coords.textContent = `${tx}, ${ty}`
        }

        function clearAllCanvases() {
            for (const [_, canvas] of Object.entries(c)) {
                clearCanvas(canvas)
            }
        }
        function clearCanvas(canvas) {
            canvas.ctx.fillStyle = 'rgba(255, 255, 255, 1)';
            canvas.ctx.fillRect(0,0,canvas.canvas.width,canvas.canvas.height);
        }

        function getRealCoordinates(canvas, x, y) {
            var realX = x - canvas.canvas.offsetLeft;
            var realY = y - canvas.canvas.offsetTop;
            realX = realX >= 0 ? realX : 0;
            realY = realY >= 0 ? realY : 0;
            return { realX, realY };
        }


    </script>
</html>